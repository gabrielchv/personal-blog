<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Simple Blog</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* White background */
        }
        /* Custom scrollbar for the modal content */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
    </style>
</head>
<body class="antialiased">
    <!-- Main Content Area (Post Grid) -->
    <main class="max-w-4xl mx-auto p-4 md:p-6">
        <!-- Post Grid: 3 Columns -->
        <div id="post-grid" class="grid grid-cols-3 gap-1 md:gap-4">
            <!-- Posts will be generated here by JavaScript -->
        </div>
    </main>

    <!-- Post Detail Modal -->
    <div id="post-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4" onclick="closePostModal(event)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-full md:h-5/6 overflow-hidden" onclick="event.stopPropagation()">
            <div class="flex flex-col md:flex-row h-full">
                
                <!-- Left Side: Media Carousel/Container -->
                <div id="modal-media-container" class="md:w-3/5 bg-gray-100 flex items-center justify-center p-2 md:p-0 overflow-hidden relative">
                    <!-- Media items will be injected here -->
                    <div id="modal-media-content" class="w-full h-full"></div>
                </div>

                <!-- Right Side: Details and Close Button -->
                <div class="md:w-2/5 p-6 flex flex-col relative max-h-128 md:max-h-full">
                    <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 transition" onclick="closePostModal()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    
                    <h3 id="modal-title" class="text-2xl font-bold text-gray-800 pr-10 mb-2"></h3>
                    <p class="text-sm font-semibold text-indigo-500 mb-4">Postado em: <span id="modal-date" class="font-normal text-gray-500"></span></p>

                    <!-- Scrollable Description -->
                    <div class="modal-content overflow-y-auto pr-2 flex-grow">
                        <p id="modal-description" class="text-gray-700 leading-relaxed whitespace-pre-wrap"></p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let POSTS = []; // Will be populated by API call

        // --- CORE FUNCTIONS ---
        
        // Function to find a post by ID
        const getPostById = (id) => POSTS.find(p => p.id === id);

        // Function to create HTML for a single media item in the modal
        const createMediaElement = (media) => {
            const container = document.createElement('div');
            container.className = 'w-full h-auto p-4 flex items-center justify-center';

            if (media.type === 'video') {
                const video = document.createElement('video');
                video.src = media.url;
                video.className = 'w-full h-auto max-h-full rounded-lg shadow-xl';
                video.controls = true;
                video.loop = true;
                video.autoplay = false; // Prevent autoplay for resource saving
                video.muted = true; // Required for mobile autoplay if you enable it
                container.appendChild(video);
            } else if (media.type === 'image') {
                const img = document.createElement('img');
                img.src = media.url;
                img.alt = 'Post media';
                img.className = 'w-full h-auto max-h-full object-contain rounded-lg shadow-xl';
                img.loading = 'lazy'; // Lazy load the modal media
                container.appendChild(img);
            }
            return container;
        };

        // Function to open the post modal
        window.openPostModal = function(postId) {
            const post = getPostById(postId);
            if (!post) return;

            // 1. Populate Text Content
            document.getElementById('modal-title').textContent = post.title;
            document.getElementById('modal-date').textContent = post.date;
            document.getElementById('modal-description').textContent = post.description;

            // 2. Populate Media Content
            const mediaContainer = document.getElementById('modal-media-content');
            mediaContainer.innerHTML = ''; // Clear previous content

            // Create a simple, vertical stack of media for the modal
            const mediaStack = document.createElement('div');
            mediaStack.className = 'w-full h-full overflow-y-auto modal-content';

            post.media.forEach(media => {
                mediaStack.appendChild(createMediaElement(media));
            });
            mediaContainer.appendChild(mediaStack);

            // 3. Display Modal
            document.getElementById('post-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        // Function to close the post modal
        window.closePostModal = function(event) {
            // Check if the click was on the modal background itself (not inside the content)
            if (event && event.target.id !== 'post-modal') {
                return;
            }

            // Stop any playing videos before hiding the modal
            const videoElements = document.querySelectorAll('#modal-media-content video');
            videoElements.forEach(video => video.pause());

            document.getElementById('post-modal').classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Function to fetch posts from API and render the grid
        async function loadPosts() {
            try {
                const response = await fetch('/api/posts');
                POSTS = await response.json();
                renderPostGrid();
            } catch (error) {
                console.error('Error loading posts:', error);
            }
        }

        // Function to render the post grid
        function renderPostGrid() {
            const grid = document.getElementById('post-grid');
            grid.innerHTML = ''; // Clear existing content
            
            POSTS.forEach(post => {
                // Get the first media item for the thumbnail
                const thumbnailMedia = post.media[0];

                const gridItem = document.createElement('div');
                gridItem.className = 'relative group cursor-pointer aspect-square bg-gray-100 overflow-hidden rounded-md transition duration-300 transform hover:scale-[1.01] hover:shadow-lg';
                gridItem.setAttribute('onclick', `openPostModal(${post.id})`);

                let mediaHtml = '';
                let overlayIcon = '';

                if (thumbnailMedia.type === 'video') {
                    // Use a placeholder video element for the grid thumbnail
                    mediaHtml = `
                        <video src="${thumbnailMedia.url}" class="w-full h-full object-cover" loop muted autoplay playsinline disablepictureinpicture>
                            Your browser does not support the video tag.
                        </video>
                    `;
                    // Simple video icon for visual cue
                    overlayIcon = `
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132c.232-.155.232-.485 0-.64z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    `;

                } else if (thumbnailMedia.type === 'image') {
                    // Use an image element for the grid thumbnail
                    mediaHtml = `<img src="${thumbnailMedia.url}" alt="${post.title}" class="w-full h-full object-cover transition duration-500 group-hover:opacity-80" loading="lazy">`;
                    // Simple photo icon
                     overlayIcon = `
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    `;
                }

                gridItem.innerHTML = `
                    ${mediaHtml}
                    <!-- Overlay to show title/icon on hover -->
                    <div class="absolute inset-0 bg-black bg-opacity-30 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 p-4">
                        ${overlayIcon}
                        <p class="text-white text-center text-sm font-semibold mt-2">${post.title}</p>
                        <p class="text-white text-center text-sm font-semibold mt-2">${post.date}</p>
                    </div>
                `;

                grid.appendChild(gridItem);
            });
        }

        // --- INITIAL RENDER ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPosts();
        });
    </script>

</body>
</html>
